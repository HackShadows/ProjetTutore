{% extends "page.tmpl" %}
{% set nav_current = 4 %}

{% block nav %}
    {# On s'assure que l'onglet Victoire est bien ajouté et actif #}
    {% set nav_items = nav_items + [{"target": "/victoire?image_id=" ~ image['id_image'], "text": "Victoire"}] %}
    {{ nav_tmpl.nav(nav_items, 4) }}
{% endblock %}

{% block main %}
<div class="container py-4">
    <div class="text-center mb-5">
        <div class="display-3 text-success mb-2">
            <i class="bi bi-trophy-fill"></i>
        </div>
        <h1 class="fw-bold">Félicitations !</h1>
        <p class="lead text-muted">Vous avez reconstitué le puzzle avec succès.</p>
    </div>

    <div class="row g-4 justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <img src="{{ image['url'] }}" class="card-img-top rounded shadow" alt="Monument complété" style="max-height: 500px; object-fit: contain; background: #f8f9fa;">
                <div class="card-body text-center bg-light border-top">
                    <span class="badge bg-primary px-3 py-2">Puzzle Terminé</span>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    
                    {# CAS 1 : Le joueur doit deviner (Premier essai) #}
                    {% if image['public'] and not trouve and not essai and not revele %}
                        <h3 class="h5 fw-bold mb-3 text-center">Saurez-vous deviner le nom de ce monument ?</h3>
                        <form action="/devinerMonument" method="POST" class="mt-3">
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-white"><i class="bi bi-pencil"></i></span>
                                <input type="text" id="monument" name="monument" class="form-control" placeholder="Entrez votre réponse..." required>
                                <input type="hidden" name="id_image" value="{{ image['id_image'] }}">
                                <button type="submit" class="btn btn-primary">Valider</button>
                            </div>
                        </form>

                    {# CAS 2 : Succès ou Révélation (Affichage des infos) #}
                    {% elif image['public'] and (trouve or revele) %}
                        {% if trouve %}
                            <div class="alert alert-success d-flex align-items-center mb-4" role="alert">
                                <i class="bi bi-check-circle-fill me-2 fs-4"></i>
                                <div><strong>Bravo !</strong> Vous avez trouvé : <em>{{ monument }}</em></div>
                            </div>
                        {% endif %}

                        <h4 class="fw-bold mb-4 border-bottom pb-2">Informations sur l'édifice</h4>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold text-secondary small text-uppercase">Nom du monument</div>
                                    <span class="fs-5">{{ image['nom_monument'] }}</span>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold text-secondary small text-uppercase">Localisation</div>
                                    <span><i class="bi bi-geo-alt-fill text-danger"></i> {{ image['nom_commune'] }}</span>
                                </div>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-start px-0 border-bottom-0">
                                <div class="ms-2 me-auto">
                                    <div class="fw-bold text-secondary small text-uppercase">Description</div>
                                    <p class="text-muted mb-0 small italic">{{ image['description'] if image['description'] else "Aucune description disponible." }}</p>
                                </div>
                            </li>
                        </ul>
                        <div class="mt-4 d-grid gap-2">
                            <a href="/map" class="btn btn-outline-primary">Retour à la carte</a>
                            <a href="/play" class="btn btn-primary">Jouer à nouveau</a>
                        </div>

                    {# CAS 3 : Mauvaise réponse (Option Révéler) #}
                    {% elif image['public'] and essai %}
                        <div class="alert alert-warning mb-4 text-center">
                            <i class="bi bi-exclamation-triangle-fill fs-4 d-block mb-2"></i>
                            Ce n'est pas la bonne réponse... Retentez votre chance !
                        </div>
                        
                        <form action="/devinerMonument" method="POST" class="mb-3">
                            <div class="input-group">
                                <input type="text" id="monument" name="monument" class="form-control" placeholder="Nouvel essai..." required>
                                <input type="hidden" name="id_image" value="{{ image['id_image'] }}">
                                <button type="submit" class="btn btn-primary">Essayer</button>
                            </div>
                        </form>

                        <div class="text-center mt-3">
                            <span class="text-muted small d-block mb-2">Ou alors...</span>
                            <form action="/revelerMonument" method="POST">
                                <input type="hidden" name="id_image" value="{{ image['id_image'] }}">
                                <button type="submit" class="btn btn-link text-secondary btn-sm p-0">Révéler la solution</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}