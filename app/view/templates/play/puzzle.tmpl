{% extends "page.tmpl" %}

{% block css %}
<style>
    {% set board_width_vw = 45 %}
    {% set board_height_vw = board_width_vw * board_height / board_width %}
    {% set cell_size_vw = board_width_vw / board_width %}

    .game-container {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
        justify-content: center;
        flex-wrap: wrap;
    }

    .puzzle-board {
        width: {{board_width_vw}}vw;
        height: {{board_height_vw}}vw;
        background-color: #e9ecef;
        border: 3px solid #dee2e6;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }

    .puzzle-row {
        display: flex;
        flex-direction: row;
        height: {{cell_size_vw}}vw;
    }

    .puzzle-cell {
        width: {{cell_size_vw}}vw;
        height: {{cell_size_vw}}vw;
        border: 1px dashed #ced4da;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .piece-bank {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        min-width: 320px;
    }

    .puzzle-tile {
        width: {{cell_size_vw}}vw;
        height: {{cell_size_vw}}vw;
        cursor: grab;
        z-index: 100;
        margin: 5px;
    }

	.puzzle-tile:active { cursor: grabbing; }

    /* Important pour l'insertion parfaite dans la grille */
    .puzzle-cell .puzzle-tile {
        margin: 0;
    }

    .puzzle-tile img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none; /* Indispensable pour le drag and drop et dblclick */
        border-radius: 4px;
    }

	.puzzle-hint {
        background: #fff3cd;
        color: #856404;
        padding: 0.75rem;
        border-radius: 8px;
        border-left: 5px solid #ffeeba;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block main %}
<div id="game-area" class="container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">{% block puzzle_title %}Puzzle{% endblock %}</h2>
            <p class="text-muted">Assemblez les pièces pour découvrir le monument.</p>
        </div>
		<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAide">
			Aide
		</button>
        <a href="/play" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Abandonner
        </a>
    </div>

    <div class="puzzle-hint shadow-sm">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>Astuce :</strong> Déplacez les pièces en "drag and drop". <strong>Double-cliquez</strong> sur une pièce pour la faire pivoter.
    </div>

    <div hidden>
        <span id="board-width">{{ board_width }}</span>
        <span id="board-height">{{ board_height }}</span>
        <span id="solution-hash">{{ solution_hash }}</span>
        <span id="image-id">{{ image['id_image'] }}</span>
        <input id="imageurl" type="hidden" value="{{ image['url'] }}">
        <input id="imagesize" type="hidden" value="{{ board_width }}">
        <input id="cellsize" type="hidden" value="300">
        <input id="resolution" type="hidden" value="{{ 900/board_width }}">
    </div>

	<div class="modal fade" id="modalAide" tabindex="-1" aria-labelledby="modalAideLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalConfirmationLabel">Puzzle</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body text-center">
					<img src="{{ image['url'] }}" class="img-fluid rounded shadow-sm" alt="Aperçu du puzzle">
				</div>
			</div>
		</div>
	</div>

    <div class="game-container">
        <div class="puzzle-board shadow-sm" id="board">
            {% for row in range(board_height) %}
            <div class="puzzle-row">
                {% for col in range(board_width) %}
                <div class="puzzle-cell" id="puzzle-cell-{{ row + 1 }}-{{ col + 1 }}"></div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <div class="piece-bank">
            <h6 class="text-uppercase fw-bold text-muted small mb-3 text-center">Pièces</h6>
            <div id="tile-container" class="d-flex flex-wrap justify-content-center">
                {% for i in range (board_width * board_height) %}
                <div class="puzzle-tile" draggable="true" id="tile-wrapper-{{ i }}">
                    <div class="puzzle-image-container">
                        <img id="tile{{ i }}" style="transform: rotate(0deg)">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
    <script src="/static/js/script-split-puzzle.js"></script>
    <script src="/static/js/script-puzzle-tiles.js"></script>
    <script>
        // Lance la génération des images au chargement
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof demarrerJeu === "function") demarrerJeu();
        });
    </script>
{% endblock %}